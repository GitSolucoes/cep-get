<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Inteligente</title>
  <link rel="stylesheet" href="static/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- Logo -->
  <div class="logo">
    <img src="/static/preta_reta_azul (1).svg" alt="Logo" />
  </div>

  <!-- Header -->
  <header>
    <h1>Selecionar tipo de busca</h1>
    <div class="btn-container">
      <button id="btn-rua" class="btn-opcao">RUA</button>
      <button id="btn-bairro" class="btn-opcao">BAIRRO</button>
      <button id="btn-cidade" class="btn-opcao">CIDADE</button>
      <button id="btn-estado" class="btn-opcao">ESTADO</button>
      <button id="btn-cep" class="btn-opcao">CEP</button>
    </div>
  </header>

  <!-- Formulários -->
  <main>
    <!-- (mesmo conteúdo de forms rua, bairro, cidade, estado...) -->

    <section id="form-cep" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="cep-form" class="formulario fade-in">
        <h2>Consulta de CEPs</h2>
        <div>
          <label for="cep" class="form-label">Digite o CEP:</label>
          <input type="text" id="cep" name="cep" class="form-campo" />
        </div>
        <div>
          <label for="arquivo-cep" class="form-label">Ou envie um arquivo (.txt, .csv, .xlsx):</label>
          <input type="file" id="arquivo-cep" name="arquivo" class="form-campo" accept=".txt,.csv,.xlsx" />
        </div>
        <div>
          <label for="formato-cep" class="form-label">Formato de Download:</label>
          <select id="formato-cep" name="formato" class="form-campo">
            <option value="txt">TXT</option>
            <option value="xlsx">Excel</option>
          </select>
        </div>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-cep" style="display:none;">Carregando...</div>
      </form>
    </section>
  </main>

  <!-- Resultado -->
  <div id="resultado"></div>

  <!-- Scripts -->
  <script>
  // CEP form submit
  document.getElementById("cep-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    let cep = document.getElementById("cep").value;
    cep = cep.replace(/\D/g, "");  // Remove tudo que não for número

    const arquivo = document.getElementById("arquivo-cep").files[0];
    const formato = document.getElementById("formato-cep").value;
    const carregando = document.getElementById("carregando-cep");
    const resultadoDiv = document.getElementById("resultado");

    carregando.style.display = "block";
    resultadoDiv.innerHTML = "";

    const formData = new FormData();
    if (arquivo) {
      formData.append("arquivo", arquivo);
    } else {
      formData.append("cep", cep);
    }
    formData.append("formato", formato);

    const response = await fetch("/buscar", {
      method: "POST",
      body: formData,
    });

    carregando.style.display = "none";

    if (response.ok) {
      if (formato === "xlsx") {
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "resultado.xlsx";
        link.click();
        resultadoDiv.innerHTML = '<div class="download-msg">Download concluído!</div>';
      } else {
        const data = await response.json();
        if (data.resultados?.length > 0) {
          data.resultados.forEach((res) => {
            const card = document.createElement("div");
            card.className = "resultado-card";
            card.innerHTML = `
              <div class="card-section">
                <p><strong>Cliente:</strong> ${res.cliente}</p>
                <p><strong>CEP:</strong> ${res.cep}</p>
                <p><strong>Categoria:</strong> ${res.categoria}</p>
                <p><strong>Fase:</strong> ${res.fase}</p>
              </div>`;
            resultadoDiv.appendChild(card);
          });
        } else {
          resultadoDiv.innerHTML = '<div class="nenhum-resultado">Nenhum resultado encontrado.</div>';
        }
      }
    } else {
      const erro = await response.json();
      resultadoDiv.innerHTML = `<div class="nenhum-resultado">Erro: ${erro.error || "Erro desconhecido."}</div>`;
    }
  });

  // Botões para exibir formulários
  const botoes = document.querySelectorAll(".btn-opcao");
  const formularios = {
    rua: document.getElementById("form-rua"),
    bairro: document.getElementById("form-bairro"),
    cidade: document.getElementById("form-cidade"),
    estado: document.getElementById("form-estado"),
    cep: document.getElementById("form-cep"),
  };

  botoes.forEach((btn) => {
    btn.addEventListener("click", () => {
      botoes.forEach((b) => b.classList.remove("ativo"));
      btn.classList.add("ativo");

      Object.values(formularios).forEach((f) => f.style.display = "none");

      const id = btn.id.replace("btn-", "");
      const form = formularios[id];
      if (form) {
        form.style.display = "flex";
        form.scrollIntoView({ behavior: "smooth" });
      }
    });
  });
  </script>
</body>
</html>
