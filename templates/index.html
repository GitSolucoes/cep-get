<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Inteligente</title>
  <link rel="stylesheet" href="/static/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="logo">
    <img src="/static/preta_reta_azul (1).svg" alt="Logo" />
  </div>

  <header>
    <h1>Selecionar tipo de busca</h1>
    <div class="btn-container">
      <button id="btn-rua" class="btn-opcao">RUA</button>
      <button id="btn-bairro" class="btn-opcao">BAIRRO</button>
      <button id="btn-cidade" class="btn-opcao">CIDADE</button>
      <button id="btn-estado" class="btn-opcao">ESTADO</button>
      <button id="btn-cep" class="btn-opcao">CEP</button>
    </div>
  </header>

  <main>
    <!-- FormulÃ¡rios -->
    <section id="form-rua" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="rua-form" class="formulario fade-in">
        <h2>Consulta por Rua</h2>
        <input type="text" id="rua" class="form-campo" placeholder="Digite a rua..." />
        <input type="file" id="arquivo-rua" class="form-campo" accept=".txt,.csv,.xlsx" />
        <select id="formato-rua" class="form-campo">
          <option value="txt">TXT</option>
          <option value="xlsx">Excel</option>
        </select>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-rua" style="display:none;">Carregando...</div>
      </form>
    </section>

    <section id="form-bairro" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="bairro-form" class="formulario fade-in">
        <h2>Consulta por Bairro</h2>
        <input type="text" id="bairro" class="form-campo" placeholder="Digite o bairro..." />
        <input type="file" id="arquivo-bairro" class="form-campo" accept=".txt,.csv,.xlsx" />
        <select id="formato-bairro" class="form-campo">
          <option value="txt">TXT</option>
          <option value="xlsx">Excel</option>
        </select>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-bairro" style="display:none;">Carregando...</div>
      </form>
    </section>

    <section id="form-cidade" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="cidade-form" class="formulario fade-in">
        <h2>Consulta por Cidade</h2>
        <input type="text" id="cidade" class="form-campo" placeholder="Digite a cidade..." />
        <input type="file" id="arquivo-cidade" class="form-campo" accept=".txt,.csv,.xlsx" />
        <select id="formato-cidade" class="form-campo">
          <option value="txt">TXT</option>
          <option value="xlsx">Excel</option>
        </select>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-cidade" style="display:none;">Carregando...</div>
      </form>
    </section>

    <section id="form-estado" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="estado-form" class="formulario fade-in">
        <h2>Consulta por Estado</h2>
        <input type="text" id="estado" class="form-campo" placeholder="Digite o estado..." />
        <input type="file" id="arquivo-estado" class="form-campo" accept=".txt,.csv,.xlsx" />
        <select id="formato-estado" class="form-campo">
          <option value="txt">TXT</option>
          <option value="xlsx">Excel</option>
        </select>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-estado" style="display:none;">Carregando...</div>
      </form>
    </section>

    <section id="form-cep" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="cep-form" class="formulario fade-in">
        <h2>Consulta de CEPs</h2>
        <label>Digite o CEP:</label>
        <input type="text" id="cep" class="form-campo" />
        <label>Ou envie um arquivo (.txt, .csv, .xlsx):</label>
        <input type="file" id="arquivo-cep" class="form-campo" accept=".txt,.csv,.xlsx" />
        <label>Formato de Download:</label>
        <select id="formato-cep" class="form-campo">
          <option value="txt">TXT</option>
          <option value="xlsx">Excel</option>
        </select>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-cep" style="display:none;">Carregando...</div>
      </form>
    </section>
  </main>

  <div id="resultado"></div>

  <script>
    const formularios = ['cep', 'rua', 'bairro', 'cidade', 'estado'];

    document.querySelectorAll(".btn-opcao").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".form-busca").forEach(f => f.style.display = "none");
        document.querySelectorAll(".btn-opcao").forEach(b => b.classList.remove("ativo"));
        btn.classList.add("ativo");
        const tipo = btn.id.replace("btn-", "");
        document.getElementById(`form-${tipo}`).style.display = "flex";
        document.getElementById(`form-${tipo}`).scrollIntoView({ behavior: 'smooth' });
      });
    });

    function montarCards(resultados) {
      const resultadoDiv = document.getElementById("resultado");
      resultadoDiv.innerHTML = "";
      resultados.forEach(res => {
        const card = document.createElement("div");
        card.className = "resultado-card";
        card.innerHTML = `
          <div class="card-section">
            <p><strong>Cliente:</strong> ${res.cliente}</p>
            <p><strong>CEP:</strong> ${res.uf_crm_cep}</p>
            <p><strong>Categoria:</strong> ${res.categoria}</p>
            <p><strong>Fase:</strong> ${res.fase}</p>
          </div>`;
        resultadoDiv.appendChild(card);
      });
    }

    formularios.forEach(tipo => {
      const form = document.getElementById(`${tipo}-form`);
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const valor = document.getElementById(tipo).value.trim();
        const arquivo = document.getElementById(`arquivo-${tipo}`).files[0];
        const formato = document.getElementById(`formato-${tipo}`).value;
        const carregando = document.getElementById(`carregando-${tipo}`);
        const resultadoDiv = document.getElementById("resultado");

        carregando.style.display = "block";
        resultadoDiv.innerHTML = "";

        const formData = new FormData();
        if (arquivo) {
          formData.append("arquivo", arquivo);
        } else {
          formData.append(tipo, valor);
        }
        formData.append("formato", formato);

        const response = await fetch(tipo === 'cep' ? '/buscar' : `/buscar-${tipo}`, {
          method: tipo === 'cep' ? 'POST' : 'POST',
          body: formData
        });

        carregando.style.display = "none";

        if (response.ok) {
          if (formato === "xlsx") {
            const blob = await response.blob();
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = "resultado.xlsx";
            link.click();
          } else {
            const data = await response.json();
            if (data.resultados?.length > 0) {
              montarCards(data.resultados);
            } else {
              resultadoDiv.innerHTML = '<div class="nenhum-resultado">Nenhum resultado encontrado.</div>';
            }
          }
        } else {
          resultadoDiv.innerHTML = '<div class="nenhum-resultado">Erro ao consultar.</div>';
        }
      });
    });
  </script>
</body>
</html>
