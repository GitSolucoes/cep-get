<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Inteligente</title>
  <link rel="stylesheet" href="/static/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="logo">
    <img src="/static/preta_reta_azul (1).svg" alt="Logo" />
  </div>

  <header>
    <h1>Selecionar tipo de busca</h1>
    <div class="btn-container">
      <button id="btn-rua" class="btn-opcao">RUA</button>
      <button id="btn-bairro" class="btn-opcao">BAIRRO</button>
      <button id="btn-cidade" class="btn-opcao">CIDADE</button>
      <button id="btn-estado" class="btn-opcao">ESTADO</button>
      <button id="btn-cep" class="btn-opcao">CEP</button>
    </div>
  </header>

  <main>
    <section id="form-section" style="flex-direction: column; align-items: center;">
      <form id="busca-form" class="formulario fade-in">
        <h2 id="form-titulo">Consulta</h2>
        <input type="hidden" id="tipo-busca" name="tipo_busca" value="cep" />
        <div>
          <label for="valor" class="form-label" id="label-valor">Digite o CEP:</label>
          <input type="text" id="valor" name="valor" class="form-campo" />
        </div>
        <div>
          <label for="arquivo-cep" class="form-label">Ou envie um arquivo (.txt, .csv, .xlsx):</label>
          <input type="file" id="arquivo-cep" name="arquivo" class="form-campo" accept=".txt,.csv,.xlsx" />
        </div>
        <div>
          <label for="formato-cep" class="form-label">Formato de Download:</label>
          <select id="formato-cep" name="formato" class="form-campo">
            <option value="txt">TXT</option>
            <option value="xlsx">Excel</option>
          </select>
        </div>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando" style="display:none;">Carregando...</div>
      </form>
    </section>
  </main>

  <div id="resultado"></div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const botoes = document.querySelectorAll(".btn-opcao");
      const formTitulo = document.getElementById("form-titulo");
      const labelValor = document.getElementById("label-valor");
      const tipoBuscaInput = document.getElementById("tipo-busca");

      const labels = {
        cep: "Digite o CEP:",
        rua: "Digite a rua:",
        bairro: "Digite o bairro:",
        cidade: "Digite a cidade:",
        estado: "Digite o estado:"
      };

      botoes.forEach((btn) => {
        btn.addEventListener("click", () => {
          botoes.forEach((b) => b.classList.remove("ativo"));
          btn.classList.add("ativo");

          const tipo = btn.id.replace("btn-", "");
          tipoBuscaInput.value = tipo;
          formTitulo.textContent = `Consulta por ${tipo.toUpperCase()}`;
          labelValor.textContent = labels[tipo];
          document.getElementById("valor").value = "";
          document.getElementById("arquivo-cep").value = "";
          document.getElementById("resultado").innerHTML = "";
          document.getElementById("form-section").scrollIntoView({ behavior: "smooth" });
        });
      });

      document.getElementById("busca-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const tipoBusca = tipoBuscaInput.value;
        let valor = document.getElementById("valor").value.trim();
        const arquivo = document.getElementById("arquivo-cep").files[0];
        const formato = document.getElementById("formato-cep").value;
        const carregando = document.getElementById("carregando");
        const resultadoDiv = document.getElementById("resultado");

        if (tipoBusca === "cep") {
          valor = valor.replace(/\D/g, "");
        }

        carregando.style.display = "block";
        resultadoDiv.innerHTML = "";

        const formData = new FormData();
        formData.append("tipo_busca", tipoBusca);
        if (arquivo) {
          formData.append("arquivo", arquivo);
        } else {
          formData.append("valor", valor);
        }
        formData.append("formato", formato);

        const response = await fetch("/buscar", {
          method: "POST",
          body: formData,
        });

        carregando.style.display = "none";

        if (response.ok) {
          if (formato === "xlsx") {
            const blob = await response.blob();
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = "resultado.xlsx";
            link.click();
            resultadoDiv.innerHTML = '<div class="download-msg">Download concluído!</div>';
          } else {
            const data = await response.json();
            if (data.resultados?.length > 0) {
              data.resultados.forEach((res) => {
                const card = document.createElement("div");
                card.className = "resultado-card";
                card.innerHTML = `
                  <div class="card-section">
                    <p><strong>Cliente:</strong> ${res.cliente}</p>
                    <p><strong>CEP:</strong> ${res.uf_crm_cep}</p>
                    <p><strong>Categoria:</strong> ${res.categoria}</p>
                    <p><strong>Fase:</strong> ${res.fase}</p>
                    <p><strong>Contato:</strong> ${res.contato}</p>
                    <p><strong>Criado em:</strong> ${res.criado_em}</p>
                    <p><strong>Contato 1:</strong> ${res.contato01}</p>
                    <p><strong>Contato 2:</strong> ${res.contato02}</p>
                    <p><strong>Ordem de Serviço:</strong> ${res.ordem_de_servico}</p>
                    <p><strong>Nome do Cliente:</strong> ${res.nome_do_cliente}</p>
                    <p><strong>Nome da Mãe:</strong> ${res.nome_da_mae}</p>
                    <p><strong>Data de Vencimento:</strong> ${res.data_de_vencimento}</p>
                    <p><strong>Email:</strong> ${res.email}</p>
                    <p><strong>CPF:</strong> ${res.cpf}</p>
                    <p><strong>RG:</strong> ${res.rg}</p>
                    <p><strong>Referência:</strong> ${res.referencia}</p>
                    <p><strong>Rua:</strong> ${res.rua}</p>
                    <p><strong>Data de Instalação:</strong> ${res.data_de_instalacao}</p>
                    <p><strong>Operadoras:</strong> ${res.quais_operadoras_tem_viabilidade}</p>
                    <p><strong>Bairro:</strong> ${res.uf_crm_bairro}</p>
                    <p><strong>Cidade:</strong> ${res.uf_crm_cidade}</p>
                    <p><strong>Número:</strong> ${res.uf_crm_numero}</p>
                    <p><strong>UF:</strong> ${res.uf_crm_uf}</p>
                  </div>`;
                resultadoDiv.appendChild(card);
              });
            } else {
              resultadoDiv.innerHTML = '<div class="nenhum-resultado">Nenhum resultado encontrado.</div>';
            }
          }
        } else {
          const erro = await response.json();
          resultadoDiv.innerHTML = `<div class="nenhum-resultado">Erro: ${erro.error || "Erro desconhecido."}</div>`;
        }
      });
    });
  </script>
</body>
</html>
