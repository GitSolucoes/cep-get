<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Inteligente</title>
  <link rel="stylesheet" href="static/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- Logo -->
  <div class="logo">
    <img src="/static/preta_reta_azul (1).svg" alt="Logo" />
  </div>

  <!-- Header -->
  <header>
    <h1>Selecionar tipo de busca</h1>
    <div class="btn-container">
      <button id="btn-rua" class="btn-opcao">RUA</button>
      <button id="btn-bairro" class="btn-opcao">BAIRRO</button>
      <button id="btn-cidade" class="btn-opcao">CIDADE</button>
      <button id="btn-estado" class="btn-opcao">ESTADO</button>
      <button id="btn-cep" class="btn-opcao">CEP</button>
    </div>
  </header>

  <!-- Formulários -->
  <main>
    <section id="form-rua" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="rua-form" class="formulario fade-in">
        <h2>Consulta por Rua</h2>
        <!-- Seus inputs e botões da rua aqui -->
      </form>
    </section>

    <section id="form-bairro" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="bairro-form" class="formulario fade-in">
        <h2>Consulta por Bairro</h2>
        <!-- Seus inputs e botões do bairro aqui -->
      </form>
    </section>

    <section id="form-cidade" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="cidade-form" class="formulario fade-in">
        <h2>Consulta por Cidade</h2>
        <!-- Seus inputs e botões da cidade aqui -->
      </form>
    </section>

    <section id="form-estado" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="estado-form" class="formulario fade-in">
        <h2>Consulta por Estado</h2>
        <!-- Seus inputs e botões do estado aqui -->
      </form>
    </section>

    <section id="form-cep" class="form-busca" style="display: none; flex-direction: column; align-items: center;">
      <form id="cep-form" class="formulario fade-in">
        <h2>Consulta de CEPs</h2>
        <div>
          <label for="cep" class="form-label">Digite o CEP:</label>
          <input type="text" id="cep" name="cep" class="form-campo" placeholder="Ex: 31015-172" />
        </div>
        <div>
          <label for="arquivo-cep" class="form-label">Ou envie um arquivo (.txt, .csv, .xlsx):</label>
          <input type="file" id="arquivo-cep" name="arquivo" class="form-campo" accept=".txt,.csv,.xlsx" />
        </div>
        <div>
          <label for="formato-cep" class="form-label">Formato de Download:</label>
          <select id="formato-cep" name="formato" class="form-campo">
            <option value="txt">TXT</option>
            <option value="xlsx">Excel</option>
          </select>
        </div>
        <button type="submit" class="form-botao">Buscar</button>
        <div id="carregando-cep" class="carregando" style="display:none;">
          <span class="loader"></span> Processando sua busca...
        </div>
      </form>
    </section>
  </main>

  <div id="resultado"></div>

  <!-- Scripts -->
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    // Alternância dos formulários
    const botoes = document.querySelectorAll(".btn-opcao");
    const formularios = {
      rua: document.getElementById("form-rua"),
      bairro: document.getElementById("form-bairro"),
      cidade: document.getElementById("form-cidade"),
      estado: document.getElementById("form-estado"),
      cep: document.getElementById("form-cep"),
    };

    // Ativar CEP por padrão
    document.getElementById("btn-cep").classList.add("ativo");
    document.getElementById("form-cep").style.display = "flex";

    botoes.forEach((btn) => {
      btn.addEventListener("click", () => {
        botoes.forEach((b) => b.classList.remove("ativo"));
        btn.classList.add("ativo");

        Object.values(formularios).forEach((f) => f.style.display = "none");

        const id = btn.id.replace("btn-", "");
        const form = formularios[id];
        if (form) {
          form.style.display = "flex";
          form.scrollIntoView({ behavior: "smooth" });
        }
      });
    });

    // Format CEP input
    document.getElementById("cep").addEventListener("input", function(e) {
      let value = this.value.replace(/\D/g, "");
      if (value.length > 5) {
        value = value.substring(0, 5) + "-" + value.substring(5, 8);
      }
      this.value = value;
    });

    // CEP submit
    document.getElementById("cep-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      let cep = document.getElementById("cep").value;
      cep = cep.replace(/\D/g, "");

      const arquivo = document.getElementById("arquivo-cep").files[0];
      const formato = document.getElementById("formato-cep").value;
      const carregando = document.getElementById("carregando-cep");
      const resultadoDiv = document.getElementById("resultado");

      carregando.style.display = "block";
      resultadoDiv.innerHTML = "";

      try {
        const formData = new FormData();
        if (arquivo) {
          formData.append("arquivo", arquivo);
        } else if (cep) {
          formData.append("cep", cep);
        } else {
          resultadoDiv.innerHTML = '<div class="nenhum-resultado">Por favor, informe um CEP ou selecione um arquivo.</div>';
          carregando.style.display = "none";
          return;
        }
        formData.append("formato", formato);

        const response = await fetch("/buscar", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          if (formato === "xlsx") {
            const blob = await response.blob();
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = "resultado.xlsx";
            link.click();
            resultadoDiv.innerHTML = '<div class="download-msg">Download concluído! Verifique sua pasta de downloads.</div>';
          } else {
            const data = await response.json();
            if (data.resultados?.length > 0) {
              resultadoDiv.innerHTML = `<div class="download-msg">${data.total} resultados encontrados</div>`;
              
              data.resultados.forEach((res) => {
                const card = document.createElement("div");
                card.className = "resultado-card";
                card.innerHTML = `
                  <div class="card-section">
                    <p><strong>ID:</strong> ${res.id}</p>
                    <p><strong>Cliente:</strong> ${res.cliente}</p>
                    <p><strong>Nome Completo:</strong> ${res.nome_do_cliente}</p>
                  </div>
                  <div class="card-section">
                    <p><strong>CEP:</strong> ${res.uf_crm_cep}</p>
                    <p><strong>Endereço:</strong> ${res.rua}, ${res.uf_crm_numero || 'S/N'}</p>
                    <p><strong>Bairro:</strong> ${res.uf_crm_bairro}</p>
                    <p><strong>Cidade/UF:</strong> ${res.uf_crm_cidade}/${res.uf_crm_uf}</p>
                  </div>
                  <div class="card-section">
                    <p><strong>Categoria:</strong> ${res.categoria}</p>
                    <p><strong>Fase:</strong> ${res.fase}</p>
                    <p><strong>Criado em:</strong> ${res.criado_em}</p>
                  </div>
                  <div class="card-section">
                    <p><strong>Contatos:</strong> ${res.contato01 || 'N/A'} / ${res.contato02 || 'N/A'}</p>
                    <p><strong>Email:</strong> ${res.email || 'N/A'}</p>
                    <p><strong>CPF/CNPJ:</strong> ${res.cpf || 'N/A'}</p>
                  </div>`;
                resultadoDiv.appendChild(card);
              });
            } else {
              resultadoDiv.innerHTML = '<div class="nenhum-resultado">Nenhum resultado encontrado para os critérios informados.</div>';
            }
          }
        } else {
          const erro = await response.json();
          resultadoDiv.innerHTML = `<div class="nenhum-resultado">Erro: ${erro.error || "Ocorreu um erro durante a busca."}</div>`;
        }
      } catch (error) {
        resultadoDiv.innerHTML = `<div class="nenhum-resultado">Erro: ${error.message || "Falha na conexão com o servidor."}</div>`;
      } finally {
        carregando.style.display = "none";
      }
    });
  });
  </script>
</body>
</html>
